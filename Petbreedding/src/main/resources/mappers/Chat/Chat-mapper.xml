<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="Chat">
	<resultMap type="Chatroom" id="chatroom">
		<id column="chatroom_id" property="chatId" />
		<result column="cl_num" property="cl_num" />
		<result column="bp_id" property="bp_id" />
		<result column="bp_type" property="bp_type" />
	</resultMap>

	<resultMap type="Chatmessage" id="chatmessage">
		<id column="message_id" property="mId" />
		<result column="message_sender" property="mSender" />
		<result column="message_receiver" property="mReceiver" />
		<result column="message_content" property="mContent" />
		<result column="message_sendTime" property="mSendTime" />
		<result column="chatroom_id" property="chatId" />
		<result column="message_readTime" property="mReadTime" />
		<result column="cl_num" property="cl_num" />
		<result column="bp_id" property="bp_id" />
		<result column="unread_count" property="mUnreadCount"/>
	</resultMap>
	
	<resultMap type="ChatList" id="chatList">
		<result column="chatroom_id" property="chatId"/>
		<result column="cl_num" property="cl_num"/>
		<result column="bp_id" property="bp_id"/>
		<result column="CL_NICKNAME" property="nickName"/>
		<result column="SHOP_NAME" property="shopName"/>
		<result column="MESSAGE_SENDTIME" property="mSendTime"/>
		<result column="MESSAGE_CONTENT" property="mContent"/>
		<result column="UNREAD_COUNT" property="unreadCount"/>	
	</resultMap>

	<insert id="createRoom">
		INSERT INTO CHATROOM VALUES(SEQ_CHAT_ROOMID.NEXTVAL, #{cl_num}, #{bp_id})
	</insert>

	<select id="isRoom" resultMap="chatroom">
		SELECT * FROM CHATROOM WHERE
		CL_NUM = #{cl_num} AND BP_ID = #{bp_id}
	</select>

	<insert id="insertMessage" parameterType="ChatMessage" flushCache="true">
		<if test="mUnreadCount == 1">
		INSERT INTO CHATMESSAGE (MESSAGE_ID, MESSAGE_SENDER, MESSAGE_RECEIVER, 
		MESSAGE_CONTENT, MESSAGE_SENDTIME, CHATROOM_ID, UNREAD_COUNT, CL_NUM, BP_ID)
		VALUES(SEQ_CHAT_MESSAGE.NEXTVAL, #{mSender}, #{mReceiver}, #{mContent},
		CURRENT_TIMESTAMP, #{chatId}, 1, #{cl_num}, #{bp_id})
		</if>
		<if test="mUnreadCount == 2">
		INSERT INTO CHATMESSAGE (MESSAGE_ID, MESSAGE_SENDER, MESSAGE_RECEIVER, 
		MESSAGE_CONTENT, MESSAGE_SENDTIME, CHATROOM_ID, UNREAD_COUNT, CL_NUM, BP_ID)
		VALUES(SEQ_CHAT_MESSAGE.NEXTVAL, #{mSender}, #{mReceiver}, #{mContent},
		CURRENT_TIMESTAMP, #{chatId}, 0, #{cl_num}, #{bp_id})
		</if>
	</insert>
	
	<select id="selectChatRoom" resultMap="chatroom">
		SELECT * FROM CHATROOM WHERE CHATROOM_ID = #{chatId}
	</select>

	<select id="getList" resultMap="chatList">
	SELECT C.*, D.HOS_NAME AS SHOP_NAME
	FROM
	    (
	    SELECT A.CHATROOM_ID, A.MESSAGE_CONTENT, A.MESSAGE_SENDTIME, A.CL_NUM, A.BP_ID, NVL(B.UNREAD_COUNT,0) UNREAD_COUNT
	      FROM
	            (
	            SELECT CHATROOM_ID, MESSAGE_CONTENT, MESSAGE_SENDTIME, CL_NUM, BP_ID
	            FROM
	                    (
	                    SELECT
	                    ROW_NUMBER() OVER (PARTITION BY CHATROOM_ID ORDER BY MESSAGE_SENDTIME DESC) AS RNUM,
	                    CHATROOM_ID, MESSAGE_CONTENT,TO_CHAR(MESSAGE_SENDTIME, 'YYYY-MM-DD HH24:MI:SS') MESSAGE_SENDTIME, 
	                    CL_NUM, BP_ID
	                    FROM CHATMESSAGE
	                    )SQ
	                    WHERE SQ.RNUM = 1 AND CL_NUM = #{cl_num}
	                    ORDER BY CHATROOM_ID
	            ) A
	            LEFT OUTER JOIN
	                (
	                SELECT CHATROOM_ID, COUNT(UNREAD_COUNT) UNREAD_COUNT 
	                FROM CHATMESSAGE WHERE MESSAGE_RECEIVER=#{cl_num} AND UNREAD_COUNT = 1 
	                GROUP BY CHATROOM_ID
	                )B
	            ON A.CHATROOM_ID = B.CHATROOM_ID
	    )C
	    INNER JOIN
	    (SELECT * FROM HOSPITAL UNION SELECT * FROM HAIR_SALON) D        
	ON C.BP_ID = D.BP_ID
	</select>

	<select id="getListbp_id" resultMap="chatList">
	SELECT F.*, G.HOS_NAME AS SHOP_NAME
	FROM
	    (
	    SELECT C.CHATROOM_ID, C.MESSAGE_CONTENT, C.MESSAGE_SENDTIME, C.CL_NUM, C.BP_ID, C.CL_NICKNAME, NVL(D.UNREAD_COUNT,0) UNREAD_COUNT
	      FROM
	      (
	      SELECT A.CHATROOM_ID, A.MESSAGE_CONTENT, A.MESSAGE_SENDTIME, A.CL_NUM, A.BP_ID, B.CL_NICKNAME
	      FROM
	            (
	            SELECT CHATROOM_ID, MESSAGE_CONTENT, MESSAGE_SENDTIME, CL_NUM, BP_ID
	            FROM
	                    (
	                    SELECT
	                    ROW_NUMBER() OVER (PARTITION BY CHATROOM_ID ORDER BY MESSAGE_SENDTIME DESC) AS RNUM,
	                    CHATROOM_ID, MESSAGE_CONTENT,TO_CHAR(MESSAGE_SENDTIME, 'YYYY-MM-DD HH24:MI:SS') MESSAGE_SENDTIME, 
	                    CL_NUM, BP_ID
	                    FROM CHATMESSAGE
	                    )SQ
	                    WHERE SQ.RNUM = 1 AND BP_ID = #{bp_id}
	                    ORDER BY CHATROOM_ID
	            ) A
	            INNER JOIN
	                (
	                SELECT * FROM CLIENT
	                ) B
	            ON A.CL_NUM = B.CL_NUM 
	        ) C
	        LEFT OUTER JOIN
	        (
	        SELECT CHATROOM_ID, COUNT(UNREAD_COUNT) UNREAD_COUNT 
	        FROM CHATMESSAGE WHERE MESSAGE_RECEIVER=#{bp_id} AND UNREAD_COUNT = 1 
	        GROUP BY CHATROOM_ID
	        )D
	        ON C.CHATROOM_ID = D.CHATROOM_ID
	    )F
	    INNER JOIN
	    (SELECT * FROM HOSPITAL UNION SELECT * FROM HAIR_SALON) G        
	ON F.BP_ID = G.BP_ID
	</select>

	<select id="getMessageList" resultMap="chatmessage">
		SELECT MESSAGE_SENDER, MESSAGE_RECEIVER, MESSAGE_CONTENT, 
		TO_CHAR(MESSAGE_SENDTIME, 'YYYY-MM-DD HH24:MI:SS') MESSAGE_SENDTIME, CL_NUM, BP_ID 
		FROM CHATMESSAGE 
		WHERE CHATROOM_ID=#{chatId}
	</select>

	<select id="getMessageListbp_id" resultMap="chatmessage">
		SELECT M.*, B.BP_ID
		FROM CHATMESSAGE M LEFT OUTER JOIN BUSINESS_PARTNER B
		ON
		M.MESSAGE_SENDER = B.BP_ID
		WHERE CHATROOM_ID=#{chatId}
	</select>
	
	<select id="getUnreadCount" resultMap="chatmessage">
		SELECT * FROM CHATMESSAGE WHERE MESSAGE_RECEIVER=#{mReceiver} AND CHATROOM_ID = #{chatId} AND UNREAD_COUNT = 1
	</select>

	<update id="updateUnreadCount">
		UPDATE CHATMESSAGE SET UNREAD_COUNT = 0
		WHERE message_id = #{mId}
	</update>

</mapper>
